package privateiq

import (
	"encoding/json"
	"fmt"
	"strings"

	publiciq "github.com/sonatype-nexus-community/gonexus/iq"
)

const (
	restVulnDetailsCve      = "rest/vulnerability/details/cve/%s"
	restVulnDetailsSonatype = "rest/vulnerability/details/sonatype/%s"
)

type iqIssueInfo struct {
	RefID       string `json:"refId"`
	Source      string `json:"source"`
	HTMLDetails string `json:"htmlDetails"`
}

// VulnerabilityInfoHTML returns an HTML representation of the Vulnerability Info panel of a given vulnerability
func VulnerabilityInfoHTML(iq publiciq.IQ, vulnerabilityID string) (info string, err error) {
	var endpoint string
	vulnID := strings.ToLower(vulnerabilityID)
	if strings.HasPrefix(vulnID, "cve") {
		endpoint = fmt.Sprintf(restVulnDetailsCve, vulnerabilityID)
	} else {
		endpoint = fmt.Sprintf(restVulnDetailsSonatype, vulnID)
	}

	body, _, err := FromPublic(iq).Get(endpoint)
	if err != nil {
		return
	}

	var results iqIssueInfo
	err = json.Unmarshal(body, &results)
	if err != nil {
		return
	}

	return results.HTMLDetails, nil
}
